---
- hosts: leaf01,spine01
  become: yes
  pre_tasks:
    # To prevent unexpected problems, define the minimum Cumulus Linux
    # Release supported by this demo.
    - name: Verify Minimum Software Version
      assert:
        that: "{{ansible_lsb.release | version_compare('3.0', '>=') }}"
        msg: "Cumulus Linux version must be 3.0 or later. Version {{ansible_lsb.release}} detected"

  tasks:
    - name: Enable Quagga Zebra
      lineinfile:
        dest: /etc/quagga/daemons
        line: "zebra=yes"
        regexp: "zebra="
      notify: restart quagga service

    - name: Enable Quagga OSPF
      lineinfile:
        dest: /etc/quagga/daemons
        line: "ospfd=yes"
        regexp: "ospfd="
      notify: restart quagga service

    - name: Copy Interfaces File
      copy:
        src: roles/{{ansible_hostname}}/interfaces
        dest: /etc/network/interfaces
        validate: ifup -a -s -i %s
      notify: apply interface changes

    - name: Copy Routing Configuration
      copy:
        src: roles/{{ansible_hostname}}/Quagga.conf
        dest: /etc/quagga/Quagga.conf
        validate: vtysh -C -f %s
      notify: apply quagga config

  handlers:
    - name: restart vxlan service node
      service:
        name: vxsnd
        state: restarted

    - name: restart quagga service
      service:
        name: quagga
        state: restarted

    - name: apply interface changes
      service:
        name: networking
        state: reloaded

    - name: apply quagga config
      service:
        name: quagga
        state: reloaded
