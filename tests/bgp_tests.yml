---
# Tests Executed:
#   - Verify BGP Peers are configured
#   - Verify BGP Peers are Established
#   - Verify the expected ASN is configured.

# Expected vars file format:
#   bgp:
#     spine01:
#       peers: ["swp1", "swp2", "swp3", "swp4"]
#       asn: 65531

# Pull BGP data and put it into an Ansible Variable
- name: Get BGP Info
  command: vtysh -c 'show ip bgp sum json'
  register: bgp_output
  changed_when: False

# Set a play fact as json data of the bgp output
- name: Process BGP data
  set_fact:
    configured_bgp_peers: "{{ bgp_output.stdout | from_json }}"

# Validate that the BGP peers are configured and up
# First see that the configure peer is expected in the vars file
# Then validate that the peer is in the Established state
- name: Validate BGP Peers are configured and up
  assert:
    that:
      - configured_bgp_peers.peers[item] is defined
      - configured_bgp_peers.peers[item].state == "Established"
    msg: "Detected BGP Peer {{configured_bgp_peers.peers[item]}} not in Established state"
  # Loop over the bgp parameter in the vars file
  with_items: "{{bgp[ansible_hostname].peers}}"


# Verify the correct BGP ASN is configured
- name: Validate that the correct BGP ASN is configured
  assert:
    that: "configured_bgp_peers.as == {{item}}"
    msg: "Invalid BGP ASN configured. Expected {{item}}. {{configured_bgp_peers.as}} configured."
  with_items: "{{bgp[ansible_hostname].asn}}"
