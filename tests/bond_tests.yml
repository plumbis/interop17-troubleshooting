---
# Tests Executed:
#   - Verify expected bonds are configured
#   - Validate that each bond has the correct memebers

# Expected var file format for bonds:
#   bonds:
#     leaf01:
#       bond01: ["swp1"]
#       bond02: ["swp2"]

- name: Get Bond Output
  command: net show interface bonds json
  register: bond_output
  changed_when: False

- name: Process Bond Data
  set_fact:
    configured_bonds: "{{bond_output.stdout | from_json}}"

- name: Validate Bonds are Configured
  assert:
    # Both lists are sorted first to ensure they are the same.
    that: ("{{bonds[ansible_hostname] | sort}}") == "{{configured_bonds.keys() | sort}}"
    msg: "Configured bonds do not match expected bonds on {{ansible_host}}"
  when: bonds[ansible_hostname] is defined

- name: Validate Bonds have correct members
  assert:
    # Loop over the var bonds for a host, pull the value from it.
    # For example bonds["leaf01"][item] would be "swp1"
    # and verify that "swp1" exists in the list of bond members configured on the switch.
    that: ("{{bonds[ansible_hostname][item]}}") in ("{{configured_bonds[item].iface_obj.members.keys()}}")
  when: bonds[ansible_hostname] is defined
  with_items: "{{bonds[ansible_hostname]}}"
